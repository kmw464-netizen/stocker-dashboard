
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financial Dashboard v6.2 (Strict)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
    
    <style>
        :root { --primary: #333; --bg: #f0f2f5; --white: #ffffff; --point: #007bff; --border: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; font-size: 14px; }
        .card { background: var(--white); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-width: 1200px; margin: 0 auto; position: relative; }
        
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; }
        .header h2 { margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50; }
        .badge { display: inline-block; padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: 800; color: white; vertical-align: middle; margin-left: 5px; }
        .badge.gen { background-color: #2ecc71; } .badge.fin { background: #f39c12; }
        
        .controls { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; background: #f8f9fa; padding: 8px; border-radius: 8px; flex: 1; }
        input, select, button { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; background: white; }
        
        /* ë·° ì „í™˜ ìŠ¤ìœ„ì¹˜ (ì¶”ê°€ë¨) */
        .view-switch { display: flex; background: #e9ecef; border-radius: 6px; padding: 2px; margin-left: auto; }
        .view-btn { padding: 6px 12px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; border-radius: 4px; transition: 0.2s; }
        .view-btn.active { background: white; color: var(--point); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .tabs { display: flex; gap: 6px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 8px 14px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 600; color: #555; border-radius: 20px; white-space: nowrap; font-size: 13px; }
        .tab-btn.active { background: #333; color: white; border-color: #333; }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container { position: relative; height: 60vh; min-height: 400px; display: flex; flex-direction: column; }
        
        /* ê·¸ë˜í”„ ë·° */
        .chart-layout-row { display: flex; align-items: stretch; gap: 5px; flex: 1; min-height: 0; }
        .chart-scroll-box { flex: 1; border: 1px solid var(--border); border-radius: 8px; position: relative; overflow-x: auto; overflow-y: hidden; display: flex; flex-direction: column; }
        .chart-scroll-box.no-scroll { overflow-x: hidden; }
        .chart-wrapper { height: 100%; min-width: 100%; position: relative; }
        
        /* í…Œì´ë¸” ë·° (ì¶”ê°€ë¨) */
        .table-container { display: none; flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 8px; background: white; }
        .table-container.active { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: right; }
        th { background: #f1f3f5; position: sticky; top: 0; z-index: 10; font-weight: 600; color: #444; text-align: center; border-bottom: 2px solid #ddd; }
        th:first-child, td:first-child { position: sticky; left: 0; background: inherit; z-index: 20; text-align: left; border-right: 2px solid #eee; font-weight: bold; min-width: 120px; }
        tr:hover { background-color: #f8f9fa; }
        .row-pct { color: #666; font-size: 12px; font-style: italic; background-color: #fafafa; }

        .y-slider-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 30px; background: #fff9e6; border-radius: 8px; border: 1px solid #ffeeba; }
        .zoom-slider-vertical { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 6px; flex: 1; margin: 5px 0; }
        .right-slider-min-box { display: flex; flex-direction: column; align-items: center; flex: 1; width: 100%; }
        
        .bottom-controls { margin-top: 10px; padding: 0 5px; }
        .option-group { display: none; gap: 5px; }
        .overlay-box, .ma-box { display: flex; align-items: center; gap: 5px; background: #fff4e6; padding: 4px 8px; border-radius: 6px; border: 1px solid #ffe8cc; font-size: 12px; }
        .ma-box { background: #e8f6f3; border-color: #d1f2eb; }
        .ma-checks { display: flex; gap: 5px; margin-left: 5px; }
        .compare-input { width: 100px; display: none; } .compare-input.active { display: inline-block; }
        
        #loadingOverlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 100; text-align: center; padding-top: 200px; font-weight: bold; color: var(--point); backdrop-filter: blur(2px); border-radius: 12px; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loadingOverlay">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="maker-sign">Made by KMW | v6.2 Strict (v5.2 Based)</div>
        <div class="header">
            <div><h2>ğŸ“ˆ ê¸°ì—… ë¶„ì„ <span id="industryBadge" class="badge gen">ì¼ë°˜</span></h2></div>
            <div class="view-switch">
                <button class="view-btn active" onclick="setViewMode('graph')" id="btnGraph">ğŸ“Š ê·¸ë˜í”„</button>
                <button class="view-btn" onclick="setViewMode('table')" id="btnTable">â–¦ í…Œì´ë¸”</button>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="companyInput" list="compList" placeholder="ê¸°ì—…ëª… ê²€ìƒ‰..." style="flex:1; min-width:120px;">
            <datalist id="compList"></datalist>
            
            <div class="compare-box" style="display:flex; align-items:center; gap:5px; background:#eef2f5; padding:5px 10px; border-radius:6px; border:1px solid #ddd;">
                <input type="checkbox" id="compareToggle" onchange="toggleCompareMode()"> <label for="compareToggle" style="font-size:13px;">ë¹„êµ</label>
                <input type="text" id="compareInput" list="compList" class="compare-input" placeholder="ë¹„êµ ê¸°ì—…" onchange="updateChart()">
            </div>

            <div id="stockOptions" class="option-group">
                <div class="overlay-box"><input type="checkbox" id="resultOverlay" onchange="updateChart(true)"><label for="resultOverlay">ì‹¤ì  ì˜¤ë²„ë ˆì´</label></div>
                <div class="ma-box"><span>MA:</span><div class="ma-checks">
                    <label><input type="checkbox" class="ma-chk" value="5" checked onchange="updateChart(true)">5</label>
                    <label><input type="checkbox" class="ma-chk" value="20" checked onchange="updateChart(true)">20</label>
                    <label><input type="checkbox" class="ma-chk" value="60" checked onchange="updateChart(true)">60</label>
                </div></div>
            </div>

            <div style="display:flex; gap:5px; flex:1;">
                <select id="periodSelect" onchange="updateChart()" style="flex:1"></select>
                <select id="unitSelect" onchange="updateChart()" style="width:80px;">
                    <option value="100000000" selected>ì–µì›</option>
                    <option value="1000000">ë°±ë§Œ</option>
                </select>
            </div>
            <div id="consolControl" style="display:flex; background:#eee; border-radius:4px; padding:2px;">
                <input type="radio" name="consol" value="ë³„ë„" id="sep" checked onchange="updateChart()"><label for="sep" style="font-size:11px; padding:4px 8px; cursor:pointer;">ë³„ë„</label>
                <input type="radio" name="consol" value="ì—°ê²°" id="con" onchange="updateChart()"><label for="con" style="font-size:11px; padding:4px 8px; cursor:pointer;">ì—°ê²°</label>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('PL_MIX', this)">ì†ìµê³„ì‚°ì„œ</button>
            <button class="tab-btn" onclick="setTab('BS_MIX', this)">ì¬ë¬´ìƒíƒœí‘œ</button>
            <button class="tab-btn" onclick="setTab('CF', this)">í˜„ê¸ˆíë¦„í‘œ</button>
            <button class="tab-btn" onclick="setTab('STOCK', this)">ì£¼ê°€/ì‹œì´</button>
        </div>

        <div class="main-container">
            <div class="chart-layout-row" id="graphView">
                <div class="y-slider-container" id="leftSliderBox">
                    <input type="range" id="leftMaxSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateLeftMax(this.value)">
                    <div style="width:100%; height:1px; background:#ccc;"></div>
                    <input type="range" id="leftMinSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateLeftMin(this.value)">
                </div>
                <div class="chart-scroll-box" id="chartScrollBox">
                    <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="y-slider-container right-side" id="rightSliderBox" style="display:none; background:#f3f0ff; border-color:#e5dbff;">
                    <input type="range" id="rightMaxSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateRightMax(this.value)">
                    <div style="width:100%; height:1px; background:#ccc;"></div>
                    <div class="right-slider-min-box" id="rightMinSliderContainer">
                        <input type="range" id="rightMinSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateRightMin(this.value)">
                    </div>
                </div>
            </div>

            <div class="table-container" id="tableView">
                <table id="dataTable">
                    <thead><tr><th>í•­ëª©</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="bottom-controls">
            <div id="simpleZoomContainer" style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:12px;">â†” ê°„ê²©</span>
                <input type="range" id="xZoomSlider" style="flex:1;" min="30" max="200" value="60" oninput="updateXScale(this.value)">
            </div>
            <div id="rangeSliderContainer" style="display:none; margin-top:10px;">
                <div id="rangeSlider"></div>
                <div id="rangeInfo" style="text-align:center; font-size:12px; margin-top:5px;"></div>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        let metadata={}, currentCompData=null, currentCompName='', currentTab='PL_MIX', myChart=null, currentViewMode='graph';
        let originalMaxY=0, originalMinY=0, originalMaxY1=0, originalMinY1=0, currentDataLength=0;

        const CONFIG_MAP = {
            'ì¼ë°˜': {
                'PL_MIX': { type: 'financial', sources: ['PL', 'Profitability'], left_items: [{key: 'ë§¤ì¶œì•¡', color: '#36A2EB', type: 'bar'}, {key: 'ì˜ì—…ì´ìµ', color: '#FF6384', type: 'bar'}], right_items: [{key: 'ë§¤ì¶œì´ì´ìµë¥ ', color: '#FFCE56', type: 'line'}, {key: 'ì˜ì—…ì´ìµë¥ ', color: '#4BC0C0', 'type': 'line'}] },
                'BS_MIX': { type: 'financial', sources: ['BS', 'Stability'], left_items: [{key: 'ìì‚°ì´ê³„', color: '#36A2EB', type: 'bar'}, {key: 'ë¶€ì±„ì´ê³„', color: '#FF6384', type: 'bar'}, {key: 'ìë³¸ì´ê³„', color: '#9966FF', type: 'bar'}], right_items: [{key: 'ë¶€ì±„ë¹„ìœ¨', color: '#FF9F40', type: 'line'}] }
            },
            'ê¸ˆìœµ': {
                'PL_MIX': { type: 'financial', sources: ['PL', 'Profitability'], left_items: [{key: 'ì˜ì—…ìˆ˜ìµ', color: '#36A2EB', type: 'bar'}, {key: 'ì˜ì—…ì´ìµ', color: '#FF6384', type: 'bar'}], right_items: [{key: 'ìˆœì´ìµë¥ ', color: '#FFCE56', type: 'line'}, {key: 'ì˜ì—…ì´ìµë¥ ', color: '#4BC0C0', 'type': 'line'}] },
                'BS_MIX': { type: 'financial', sources: ['BS', 'Stability'], left_items: [{key: 'ìì‚°ì´ê³„', color: '#36A2EB', type: 'bar'}, {key: 'ë¶€ì±„ì´ê³„', color: '#FF6384', type: 'bar'}, {key: 'ìë³¸ì´ê³„', color: '#9966FF', type: 'bar'}], right_items: [{key: 'ë¶€ì±„ë¹„ìœ¨', color: '#FF9F40', type: 'line'}] }
            }
        };
        const COMMON_CONFIG = {
            'CF': { type: 'financial', sources: ['CF'], left_items: [{key: 'ì¬ë¬´í™œë™CF', color: '#36A2EB', type: 'line'}, {key: 'íˆ¬ìí™œë™CF', color: '#FF6384', type: 'line'}, {key: 'ì˜ì—…í™œë™CF', color: '#4BC0C0', type: 'line'}], right_items: [] },
            'STOCK': { type: 'stock', left_items: [{key: 'marcap', label: 'ì‹œê°€ì´ì•¡', color: 'transparent', type: 'line', fill: false}], right_items: [] }
        };
        Object.keys(CONFIG_MAP).forEach(k => Object.assign(CONFIG_MAP[k], COMMON_CONFIG));

        // [New] í…Œì´ë¸”ìš© í–‰ ì •ì˜
        const TABLE_ROWS = {
            'PL_MIX': [
                {k:'ë§¤ì¶œì•¡', l:'ë§¤ì¶œì•¡(ìˆ˜ìµ)'}, {k:'ë§¤ì¶œì´ì´ìµ', l:'ë§¤ì¶œì´ì´ìµ'}, {k:'ë§¤ì¶œì´ì´ìµë¥ ', l:'GP%', p:true},
                {k:'íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„', l:'íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„'}, {k:'ì˜ì—…ì´ìµ', l:'ì˜ì—…ì´ìµ'}, {k:'ì˜ì—…ì´ìµë¥ ', l:'OP%', p:true},
                {k:'ì˜ì—…ì™¸ì†ìµ', l:'ì˜ì—…ì™¸ì†ìµ'}, {k:'ë‹¹ê¸°ìˆœì´ìµ', l:'ë‹¹ê¸°ìˆœì´ìµ'}, {k:'ìˆœì´ìµë¥ ', l:'NI%', p:true}
            ],
            'BS_MIX': [
                {k:'ìì‚°ì´ê³„', l:'ìì‚°ì´ê³„'}, {k:'ë¶€ì±„ì´ê³„', l:'ë¶€ì±„ì´ê³„'}, {k:'ìë³¸ì´ê³„', l:'ìë³¸ì´ê³„'}, {k:'ë¶€ì±„ë¹„ìœ¨', l:'ë¶€ì±„ë¹„ìœ¨', p:true}
            ],
            'CF': [
                {k:'ì˜ì—…í™œë™CF', l:'ì˜ì—…í™œë™CF'}, {k:'íˆ¬ìí™œë™CF', l:'íˆ¬ìí™œë™CF'}, {k:'ì¬ë¬´í™œë™CF', l:'ì¬ë¬´í™œë™CF'}, {k:'ê¸°ì´ˆí˜„ê¸ˆ', l:'ê¸°ì´ˆí˜„ê¸ˆ'}, {k:'ê¸°ë§í˜„ê¸ˆ', l:'ê¸°ë§í˜„ê¸ˆ'}
            ]
        };

        const ORDER_PRIORITY = ['ì˜ì—…ìˆ˜ìµ', 'ë§¤ì¶œì•¡', 'ì˜ì—…ì´ìµ', 'ìˆœì´ìµë¥ ', 'ë§¤ì¶œì´ì´ìµë¥ ', 'ì˜ì—…ì´ìµë¥ ', 'ìì‚°ì´ê³„', 'ë¶€ì±„ì´ê³„', 'ìë³¸ì´ê³„', 'ë¶€ì±„ë¹„ìœ¨', 'ì˜ì—…í™œë™CF', 'íˆ¬ìí™œë™CF', 'ì¬ë¬´í™œë™CF', 'ì‹œê°€ì´ì•¡', 'ì£¼ê°€'];

        window.onload = async () => {
            try {
                metadata = await (await fetch('metadata.json')).json();
                const list = document.getElementById('compList');
                Object.keys(metadata).sort().forEach(n => { let o=document.createElement('option'); o.value=n; list.appendChild(o); });
                const first = Object.keys(metadata).sort()[0];
                if(first) { document.getElementById('companyInput').value=first; loadCompanyData(first); }
            } catch(e) { alert("Loading Fail"); }
        };

        async function loadCompanyData(name) {
            if(!metadata[name]) return;
            document.getElementById('loadingOverlay').style.display='block';
            currentCompName = name;
            try {
                const res = await fetch(`data/${metadata[name].code}.json`);
                if(!res.ok) throw new Error("File missing");
                currentCompData = await res.json();
                updateMetaInfo(); initPeriodSelect(); updateChart();
            } catch(e) { alert("Data Error: "+e.message); }
            finally { document.getElementById('loadingOverlay').style.display='none'; }
        }

        // [New] ë·° ëª¨ë“œ ì „í™˜ í•¨ìˆ˜
        function setViewMode(mode) {
            currentViewMode = mode;
            document.getElementById('btnGraph').className = mode==='graph' ? 'view-btn active' : 'view-btn';
            document.getElementById('btnTable').className = mode==='table' ? 'view-btn active' : 'view-btn';
            document.getElementById('graphView').style.display = mode==='graph' ? 'flex' : 'none';
            document.getElementById('tableView').className = mode==='table' ? 'table-container active' : 'table-container';
            document.querySelector('.bottom-controls').style.display = mode==='graph' ? 'block' : 'none'; // í•˜ë‹¨ ì»¨íŠ¸ë¡¤ í† ê¸€
            if(mode==='table') updateChart();
        }

        function setTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            const conf = getCurrConfig();
            const isStock = conf.type === 'stock';
            document.getElementById('consolControl').style.display = isStock ? 'none' : 'flex';
            document.getElementById('periodSelect').style.visibility = isStock ? 'hidden' : 'visible';
            document.getElementById('stockOptions').style.display = isStock ? 'flex' : 'none';
            document.getElementById('rightSliderBox').style.display = isStock ? 'flex' : 'none';
            document.getElementById('simpleZoomContainer').style.display = isStock ? 'none' : 'flex';
            document.getElementById('rangeSliderContainer').style.display = isStock ? 'block' : 'none';
            
            const box = document.getElementById('chartScrollBox');
            if(isStock) box.classList.add('no-scroll'); else box.classList.remove('no-scroll');

            // ì£¼ê°€ íƒ­ì—ì„œëŠ” í…Œì´ë¸” ë³´ê¸° ê°•ì œ í•´ì œ (ì„ íƒì‚¬í•­)
            if(isStock && currentViewMode==='table') setViewMode('graph'); 
            updateChart();
        }

        function getCurrConfig() {
            const type = (currentCompData && currentCompData.type) || 'ì¼ë°˜';
            return (CONFIG_MAP[type] || CONFIG_MAP['ì¼ë°˜'])[currentTab];
        }

        // v5.2 initPeriodSelect (ì›ìƒë³µêµ¬)
        function initPeriodSelect() { 
            const sel = document.getElementById('periodSelect'); sel.innerHTML = ''; 
            const opts = [{'v': 'ALL_Q', 't': 'ì „ì²´ ë¶„ê¸° ì¶”ì´'}, {'v': 'ALL_Y', 't': 'ì—°ë„ë³„ í•©ê³„'}, {'v': 'divider', 't': 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'd': true}, {'v': 'CUM_1Q', 't': '1ë¶„ê¸° ëˆ„ì '}, {'v': 'CUM_2Q', 't': 'ìƒë°˜ê¸° ëˆ„ì '}, {'v': 'CUM_3Q', 't': '3ë¶„ê¸° ëˆ„ì '}, {'v': 'CUM_4Q', 't': 'ì—°ê°„ ëˆ„ì '}, {'v': 'divider', 't': 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'd': true}, {'v': 'COMP_1Q', 't': '1Q ë¹„êµ'}, {'v': 'COMP_2Q', 't': '2Q ë¹„êµ'}, {'v': 'COMP_3Q', 't': '3Q ë¹„êµ'}, {'v': 'COMP_4Q', 't': '4Q ë¹„êµ'}]; 
            opts.forEach(o => { let e = document.createElement('option'); e.value = o.v; e.text = o.t; if(o.d) e.disabled = true; sel.appendChild(e); }); 
            const type = document.querySelector('input[name="consol"]:checked').value; 
            let years = new Set(); 
            const compType = (currentCompData && currentCompData.type) || 'ì¼ë°˜';
            const currentConfig = CONFIG_MAP[compType] || CONFIG_MAP['ì¼ë°˜'];
            currentConfig['PL_MIX'].sources.forEach(src => { 
                if(currentCompData.data[type] && currentCompData.data[type][src]) 
                    currentCompData.data[type][src].forEach(r => years.add(r.year)); 
            }); 
            let d2 = document.createElement('option'); d2.disabled = true; d2.text = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; sel.appendChild(d2); 
            Array.from(years).sort().forEach(y => { let e = document.createElement('option'); e.value = y; e.text = y + "ë…„ ìƒì„¸"; sel.appendChild(e); }); 
        }

        // ===============================================
        // 4. í†µí•© ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (v5.2 ì°¨íŠ¸ + í…Œì´ë¸”)
        // ===============================================
        async function updateChart(keepZoom = false) {
            if(!currentCompData) return;
            const ctx = document.getElementById('mainChart').getContext('2d');
            const consol = document.querySelector('input[name="consol"]:checked').value;
            const tabCfg = getCurrConfig();
            const isStock = tabCfg.type === 'stock';
            const period = document.getElementById('periodSelect').value;
            const unit = parseFloat(document.getElementById('unitSelect').value);
            const showOverlay = document.getElementById('resultOverlay').checked && isStock;

            const isComp = document.getElementById('compareToggle').checked;
            const compBName = document.getElementById('compareInput').value;
            let compBData = null;
            if (isComp && compBName && metadata[compBName]) {
                try {
                    const res = await fetch(`data/${metadata[compBName].code}.json`);
                    if(res.ok) compBData = await res.json();
                } catch(e) {}
            }
            const hasComp = !!compBData;

            // ------------------------------------
            // A. ë°ì´í„° ì¤€ë¹„ (v5.2 proc ë¡œì§ ìœ ì§€)
            // ------------------------------------
            let finalLabels=[], finalDataA=[], finalDataB=[];

            if(isStock) {
                const getS = (d) => d && d.stock_data ? d.stock_data : [];
                let sA = getS(currentCompData), sB = hasComp ? getS(compBData) : [];
                let allD = new Set(sA.map(d=>d.date)); if(hasComp) sB.forEach(d=>allD.add(d.date));
                finalLabels = Array.from(allD).sort();
                const mapS = (src) => finalLabels.map(date => src.find(k=>k.date===date) || {});
                finalDataA = mapS(sA); finalDataB = hasComp ? mapS(sB) : [];
            } else {
                // [v5.2] ì´ìµë¥  ì¬ê³„ì‚° ë¡œì§ ìœ ì§€
                const proc = (dObj) => {
                    let m={}; if(!dObj || !dObj.data[consol]) return [];
                    (tabCfg.sources||['PL']).forEach(s => {
                        if(dObj.data[consol][s]) dObj.data[consol][s].forEach(r => m[r.label] = {...(m[r.label]||{}), ...r});
                    });
                    let f = Object.values(m).sort((a,b) => (a.year-b.year)||(a.quarter-b.quarter));
                    
                    if(period==='ALL_Y' || period.startsWith('CUM_')) {
                        const ys = [...new Set(f.map(d=>d.year))];
                        const tQ = period.startsWith('CUM_') ? parseInt(period.split('_')[1].replace('Q','')) : 4;
                        return ys.map(y => {
                            const its = f.filter(d => d.year===y && d.quarter<=tQ);
                            if(!its.length) return null;
                            let r = {label: `${y}ë…„ ${typeLabel(tQ)}`, year:y};
                            const sum = (k) => its.reduce((a,c) => a+(c[k]||0), 0);
                            
                            // ê°’ í•©ì‚° ë° ë¹„ìœ¨ ì¬ê³„ì‚° (í…Œì´ë¸” & ì°¨íŠ¸ ê³µìš©)
                            const sales = sum('ë§¤ì¶œì•¡') || sum('ì˜ì—…ìˆ˜ìµ');
                            const gp = sum('ë§¤ì¶œì´ì´ìµ');
                            const op = sum('ì˜ì—…ì´ìµ');
                            const ni = sum('ë‹¹ê¸°ìˆœì´ìµ') || sum('ìˆœì´ìµ');
                            
                            // v5.2ì˜ ì°¨íŠ¸ ì•„ì´í…œ + í…Œì´ë¸” ì•„ì´í…œ ëª¨ë‘ ê³„ì‚°
                            [...tabCfg.left_items, ...tabCfg.right_items, ...TABLE_ROWS['PL_MIX'], ...TABLE_ROWS['BS_MIX'], ...TABLE_ROWS['CF']].forEach(item => {
                                let k = item.key || item.k; // ì°¨íŠ¸ì„¤ì •ì—” key, í…Œì´ë¸”ì—” k
                                if(!k) return;
                                if(['ìì‚°ì´ê³„','ë¶€ì±„ì´ê³„','ìë³¸ì´ê³„','ê¸°ë§í˜„ê¸ˆ','ë¶€ì±„ë¹„ìœ¨'].includes(k)) {
                                    r[k] = its[its.length-1][k];
                                } else {
                                    r[k] = sum(k);
                                }
                            });

                            // ë¹„ìœ¨ ê°•ì œ ì¬ê³„ì‚°
                            if(sales) {
                                r['ë§¤ì¶œì´ì´ìµë¥ '] = (gp/sales)*100;
                                r['ì˜ì—…ì´ìµë¥ '] = (op/sales)*100;
                                r['ìˆœì´ìµë¥ '] = (ni/sales)*100;
                            }
                            if(r['ìë³¸ì´ê³„']) r['ë¶€ì±„ë¹„ìœ¨'] = (r['ë¶€ì±„ì´ê³„']/r['ìë³¸ì´ê³„'])*100;
                            return r;
                        }).filter(d=>d);
                    } else if(period.startsWith('COMP_')) {
                        return f.filter(d => d.quarter === parseInt(period.split('_')[1].replace('Q','')));
                    } else if(period !== 'ALL_Q') {
                        return f.filter(d => d.year == period);
                    }
                    return f;
                };
                finalDataA = proc(currentCompData);
                finalDataB = hasComp ? proc(compBData) : [];
                let allL = new Set(finalDataA.map(d=>d.label)); if(hasComp) finalDataB.forEach(d=>allL.add(d.label));
                finalLabels = Array.from(allL).sort();
                const mapD = (s,l) => l.map(lb=>s.find(d=>d.label===lb)||{});
                finalDataA = mapD(finalDataA, finalLabels); finalDataB = hasComp ? mapD(finalDataB, finalLabels) : [];
            }

            // ------------------------------------
            // B. ë Œë”ë§ ë¶„ê¸°
            // ------------------------------------
            if (currentViewMode === 'table' && !isStock) {
                renderTable(finalDataA, unit);
            } else {
                // v5.2 ì°¨íŠ¸ ë Œë”ë§ ë¡œì§ (ìƒì„¸ ê¸°ëŠ¥ ë³µì›)
                currentDataLength = finalLabels.length;
                const fs = window.innerWidth<=768?10:12;
                
                // ìŠ¬ë¼ì´ë” ë° ë²”ìœ„ ì„¤ì • (v5.2)
                let savedStartIdx=0, savedEndIdx=0;
                if(keepZoom && isStock) {
                    const sliderEl = document.getElementById('rangeSlider');
                    if(sliderEl && sliderEl.noUiSlider) {
                        const vals = sliderEl.noUiSlider.get();
                        savedStartIdx = parseInt(vals[0]); savedEndIdx = parseInt(vals[1]);
                    }
                }

                // ì¶• ê³„ì‚° (v5.2)
                let maxY=0, minY=0, maxY1=-Infinity, minY1=Infinity;
                if(!isStock) {
                    maxY1=0; minY1=0;
                    const check = (d) => {
                        if(!d) return;
                        tabCfg.left_items.forEach(i=>{ let v=(d[i.key]||0)/unit; if(v>maxY)maxY=v; if(v<minY)minY=v; });
                        tabCfg.right_items.forEach(i=>{ let v=(d[i.key]||0); if(v>maxY1)maxY1=v; if(v<minY1)minY1=v; });
                    };
                    finalDataA.forEach(check); if(hasComp) finalDataB.forEach(check);
                } else {
                    finalDataA.forEach(d => { if(d.high>0) { maxY1=Math.max(maxY1,d.high); minY1=Math.min(minY1,d.low); } });
                    if(hasComp) finalDataB.forEach(d => { if(d.high>0) { maxY1=Math.max(maxY1,d.high); minY1=Math.min(minY1,d.low); } });
                    if(maxY1===-Infinity) maxY1=100; if(minY1===Infinity) minY1=0;
                    if(showOverlay) {
                        const pData = getPerformanceData(currentCompData, consol, finalLabels);
                        [...pData.rev, ...pData.prof].forEach(v => { if(v!==null){ let val=v/unit; if(val>maxY)maxY=val; if(val<minY)minY=val; } });
                    }
                }
                originalMaxY=maxY*1.1; originalMinY=minY*1.1; originalMaxY1=maxY1*1.1; originalMinY1=minY1*0.9;
                
                if(!keepZoom) { ['leftMaxSlider','leftMinSlider','rightMaxSlider','rightMinSlider'].forEach(id=>document.getElementById(id).value=110); }

                // ë°ì´í„°ì…‹ ìƒì„± (v5.2)
                let datasets = [];
                const createDs = (isB, item, isLine, orderBase, customData=null) => {
                    const target = customData ? customData : (isB ? finalDataB : finalDataA);
                    const name = isB ? compBName : currentCompName;
                    const label = hasComp ? `${name}-${item.label||item.key}` : (item.label||item.key);
                    let color = item.color, dash = item.borderDash||[], pStyle = item.type==='bar'?'rect':'circle';
                    if(item.key==='marcap' && !isB) { color='transparent'; pStyle='circle'; }
                    else if(isB) { color='#95a5a6'; if(item.type==='line') dash=[5,5]; pStyle='triangle'; }
                    let yID = (isLine && !customData && item.key!=='marcap') ? 'y1' : 'y';
                    if(item.key==='marcap') yID='y_marcap';

                    return {
                        label: label,
                        data: target.map(d => {
                            let val = customData ? d : (d[item.key]||0);
                            if(customData && val===null) return null;
                            return (isLine && !customData && item.key!=='marcap') ? val : Math.round(val/unit);
                        }),
                        backgroundColor: isB?'transparent':(item.fill?color+'33':color),
                        borderColor: color, type: item.type, yAxisID: yID,
                        fill: item.fill&&!isB, order: orderBase+(isB?1:0),
                        pointStyle: pStyle, borderDash: dash, tension: 0.4, borderWidth: 2,
                        pointRadius: isStock? (customData?4:0) : 3, spanGaps: true,
                        datalabels: { display: (c)=>!isStock&&!isB&&c.dataset.data.length<50, anchor:'end', align:'top', font:{size:fs}, formatter:(v)=>(isLine&&!isStock)?v.toFixed(1)+'%':v.toLocaleString() }
                    };
                };

                if(isStock) {
                    const candles = finalDataA.map(d => ({ x: d.date, o: d.open, h: d.high, l: d.low, c: d.close }));
                    datasets.push({ label: currentCompName, data: candles, type: 'candlestick', yAxisID: 'y1', order: 1, color: { up: '#e74c3c', down: '#3498db', unchanged: '#999' }, datalabels:{display:false} });
                    const maColors = {5:'#2ecc71', 10:'#9b59b6', 20:'#f1c40f', 60:'#e67e22', 120:'#95a5a6'};
                    document.querySelectorAll('.ma-chk:checked').forEach(chk => {
                        const p = parseInt(chk.value);
                        datasets.push({ label: `MA${p}`, data: calculateMA(finalDataA, p), type: 'line', yAxisID: 'y1', borderColor: maColors[p]||'#333', borderWidth: 1, pointRadius: 0, order: 0, datalabels:{display:false} });
                    });
                    tabCfg.left_items.forEach(i=>datasets.push(createDs(false, i, false, 10)));
                    if(hasComp) datasets.push({ label: compBName+' (ì¢…ê°€)', data: finalDataB.map(d=>d.close), type: 'line', yAxisID: 'y1', borderColor: '#7f8c8d', borderWidth: 2, pointRadius: 0, borderDash: [5,5], order: 2, datalabels: { display: false } });
                    if(showOverlay) {
                        const pData = getPerformanceData(currentCompData, consol, finalLabels);
                        datasets.push(createDs(false, {key:'overlay_rev', label:'ë§¤ì¶œ(ì‹¤ì )', color:'#36A2EB', type:'line', borderDash:[2,2]}, false, 5, pData.rev));
                        datasets.push(createDs(false, {key:'overlay_prof', label:'ì´ìµ(ì‹¤ì )', color:'#FF6384', type:'line', borderDash:[2,2]}, false, 5, pData.prof));
                    }
                } else {
                    tabCfg.left_items.forEach(i=>{ datasets.push(createDs(false, i, false, 10)); if(hasComp) datasets.push(createDs(true, i, false, 11)); });
                    tabCfg.right_items.forEach(i=>{ datasets.push(createDs(false, i, true, 0)); if(hasComp) datasets.push(createDs(true, i, true, 1)); });
                }

                if(myChart) myChart.destroy();
                const hasRight = tabCfg.right_items.length > 0 || isStock;
                document.getElementById('rightSliderBox').style.display = hasRight ? 'flex' : 'none';
                
                let y1Opt = isStock 
                    ? { type: 'linear', display: hasRight, position: 'right', min: originalMinY1*0.9, max: originalMaxY1*(keepZoom?document.getElementById('rightMaxSlider').value/100:1.1), grid:{drawOnChartArea:false} }
                    : { type: 'linear', display: hasRight, position: 'right', suggestedMin: originalMinY1, suggestedMax: originalMaxY1, grid:{drawOnChartArea:false} };

                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: finalLabels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'top', labels:{ boxWidth:12, font:{size:fs+1}, sort: (a,b) => { const gk=(s)=>s.includes(' - ')?s.split(' - ')[1]:s; const ai=ORDER_PRIORITY.indexOf(gk(a.text)), bi=ORDER_PRIORITY.indexOf(gk(b.text)); if(ai===-1)return 1; if(bi===-1)return -1; return ai-bi; } } } },
                        scales: {
                            x: { type: isStock?'time':'category', time:{unit:'month', displayFormats:{month:'yy.MM'}}, offset:!isStock, min: (keepZoom&&isStock)?finalLabels[savedStartIdx]:undefined, max: (keepZoom&&isStock)?finalLabels[savedEndIdx]:undefined },
                            y: { display: !isStock||showOverlay, position:'left', suggestedMax: originalMaxY, suggestedMin: originalMinY },
                            y1: y1Opt,
                            y_marcap: { type: 'linear', display: false }
                        }
                    }
                });

                if(isStock && !keepZoom) initRangeSlider(finalLabels);
                else if(!isStock) updateXScale(document.getElementById('xZoomSlider').value);
            }
        }

        // [New] í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
        function renderTable(data, unit) {
            const tableHead = document.querySelector('#dataTable thead tr');
            const tableBody = document.querySelector('#dataTable tbody');
            tableHead.innerHTML = '<th>í•­ëª©</th>';
            tableBody.innerHTML = '';

            if(!data || data.length === 0) { tableBody.innerHTML = '<tr><td colspan="5">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }

            data.forEach(d => {
                let th = document.createElement('th');
                th.innerText = d.label;
                tableHead.appendChild(th);
            });

            const rows = TABLE_ROWS[currentTab] || [];
            rows.forEach(rowDef => {
                let tr = document.createElement('tr');
                if(rowDef.p) tr.className = 'row-pct';
                
                let tdName = document.createElement('td');
                tdName.innerText = rowDef.l;
                tr.appendChild(tdName);

                data.forEach(d => {
                    let td = document.createElement('td');
                    let val = d[rowDef.k] || d[rowDef.k.replace('ë¥ ','ìœ¨')]; // í˜¹ì‹œ ëª¨ë¥¼ í‚¤ê°’ ë°©ì–´
                    
                    if (val === undefined || val === null) {
                        td.innerText = '-';
                    } else {
                        if (rowDef.p) { 
                            td.innerText = val.toFixed(1) + '%';
                            if(val < 0) td.style.color = 'red';
                        } else { 
                            td.innerText = Math.round(val / unit).toLocaleString();
                        }
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (v5.2 ìœ ì§€) ---
        function typeLabel(q) { if(q===1) return '1Qëˆ„ì '; if(q===2) return 'ìƒë°˜ê¸°'; if(q===3) return '3Qëˆ„ì '; return 'ì—°ê°„'; }
        function updateMetaInfo() {
            const d = currentCompData;
            document.getElementById('industryBadge').innerText = d.type;
            document.getElementById('industryBadge').className = 'badge ' + (d.type==='ê¸ˆìœµ'?'fin':'gen');
            const sep = document.getElementById('sep'), con = document.getElementById('con');
            if(!d.data['ì—°ê²°']) { con.disabled=true; sep.checked=true; } else con.disabled=false;
            if(!d.data['ë³„ë„']) { sep.disabled=true; con.checked=true; } else sep.disabled=false;
        }
        function calculateMA(data, period) { 
            let ma = []; for(let i=0; i<data.length; i++) { if(i<period-1){ma.push(null); continue;} let sum=0; for(let j=0; j<period; j++) sum+=data[i-j].close; ma.push(sum/period); } return ma; 
        }
        function getPerformanceData(compData, consolType, stockDates) {
            if (!compData || !compData.data[consolType]) return { rev: [], prof: [] };
            let plData = compData.data[consolType]['PL'] || [];
            const qEndMap = {1: '03-31', 2: '06-30', 3: '09-30', 4: '12-31'};
            let rMap = {}, pMap = {};
            plData.forEach(item => { if(item.year && item.quarter) { const dStr = `${item.year}-${qEndMap[item.quarter]}`; rMap[dStr] = item['ë§¤ì¶œì•¡']||item['ì˜ì—…ìˆ˜ìµ']||0; pMap[dStr] = item['ì˜ì—…ì´ìµ']||0; } });
            let rev = Array(stockDates.length).fill(null), prof = Array(stockDates.length).fill(null);
            Object.keys(rMap).forEach(td => { let idx = stockDates.indexOf(td); if (idx === -1) for (let i = stockDates.length - 1; i >= 0; i--) if (stockDates[i] < td) { idx = i; break; } if (idx !== -1) { rev[idx] = rMap[td]===0?null:rMap[td]; prof[idx] = pMap[td]===0?null:pMap[td]; } });
            return { rev, prof };
        }
        function updateLeftMax(v) { if(myChart) { myChart.options.scales.y.max = (originalMaxY||100)*(v/100); myChart.update(); }}
        function updateLeftMin(v) { if(myChart) { myChart.options.scales.y.min = (originalMinY||0)*(v/100); myChart.update(); }}
        function updateRightMax(v) { if(myChart) { myChart.options.scales.y1.max = (originalMaxY1||10)*(v/100); myChart.update(); }}
        function updateRightMin(v) { if(myChart) { myChart.options.scales.y1.min = (originalMinY1||0)*(v/100); myChart.update(); }}
        function updateXScale(v) { document.querySelector('.chart-wrapper').style.width = Math.max(document.querySelector('.chart-scroll-box').clientWidth, currentDataLength*v)+'px'; }
        
        function initRangeSlider(labels) {
            const sliderEl = document.getElementById('rangeSlider'); if (!sliderEl) return;
            if (sliderEl.noUiSlider) sliderEl.noUiSlider.destroy();
            if (!labels || labels.length === 0) return;
            noUiSlider.create(sliderEl, { start: [0, labels.length-1], connect: true, range: {'min': 0, 'max': labels.length-1}, step: 1, behaviour: 'drag-tap' });
            sliderEl.noUiSlider.on('update', function (values) {
                const sVal = parseInt(values[0]), eVal = parseInt(values[1]);
                document.getElementById('rangeInfo').innerText = `${labels[sVal]} ~ ${labels[eVal]}`;
                if (myChart && getCurrConfig().type === 'stock') { 
                    myChart.options.scales.x.min = labels[sVal]; myChart.options.scales.x.max = labels[eVal]; myChart.update('none'); 
                }
            });
        }
        function downloadExcel() { if (!currentCompData) return; const type = document.querySelector('input[name="consol"]:checked').value; const wb = XLSX.utils.book_new(); ['PL', 'BS', 'CF', 'Profitability', 'Stability'].forEach(s => { if (currentCompData.data[type][s]) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(currentCompData.data[type][s]), s); }); if (currentCompData.stock_data) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(currentCompData.stock_data), 'Stock_Price'); XLSX.writeFile(wb, `${currentCompName}_í†µí•©ë°ì´í„°.xlsx`); }

        document.getElementById('companyInput').addEventListener('change', (e)=>loadCompanyData(e.target.value));
        window.addEventListener('resize', ()=>updateChart());
    </script>
</body>
</html>

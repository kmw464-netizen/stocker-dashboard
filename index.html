
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Financial Dashboard v6.4</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
    
    <style>
        :root { --primary: #333; --bg: #f0f2f5; --white: #ffffff; --point: #007bff; --border: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; font-size: 14px; }
        .card { background: var(--white); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-width: 1200px; margin: 0 auto; position: relative; }
        
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; }
        .header h2 { margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50; }
        .badge { display: inline-block; padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: 800; color: white; vertical-align: middle; margin-left: 5px; }
        .badge.gen { background-color: #2ecc71; } .badge.fin { background: #f39c12; }
        
        .controls { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; background: #f8f9fa; padding: 8px; border-radius: 8px; flex: 1; }
        input, select, button { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; background: white; }
        
        .view-switch { display: flex; background: #e9ecef; border-radius: 6px; padding: 2px; margin-left: auto; }
        .view-btn { padding: 6px 12px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; border-radius: 4px; transition: 0.2s; }
        .view-btn.active { background: white; color: var(--point); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .tabs { display: flex; gap: 6px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 8px 14px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 600; color: #555; border-radius: 20px; white-space: nowrap; font-size: 13px; }
        .tab-btn.active { background: #333; color: white; border-color: #333; }

        .main-container { position: relative; height: 60vh; min-height: 400px; display: flex; flex-direction: column; }
        .chart-layout-row { display: flex; align-items: stretch; gap: 5px; flex: 1; min-height: 0; }
        .chart-scroll-box { flex: 1; border: 1px solid var(--border); border-radius: 8px; position: relative; overflow-x: auto; overflow-y: hidden; display: flex; flex-direction: column; }
        .chart-scroll-box.no-scroll { overflow-x: hidden; }
        .chart-wrapper { height: 100%; min-width: 100%; position: relative; }
        
        .table-container { display: none; flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 8px; background: white; }
        .table-container.active { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: right; }
        th { background: #f1f3f5; position: sticky; top: 0; z-index: 10; font-weight: 600; color: #444; text-align: center; border-bottom: 2px solid #ddd; }
        th:first-child, td:first-child { position: sticky; left: 0; background: inherit; z-index: 20; text-align: left; border-right: 2px solid #eee; font-weight: bold; min-width: 120px; }
        tr:hover { background-color: #f8f9fa; }
        .row-pct { color: #666; font-size: 12px; font-style: italic; background-color: #fafafa; }

        .y-slider-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 30px; background: #fff9e6; border-radius: 8px; border: 1px solid #ffeeba; }
        .zoom-slider-vertical { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 6px; flex: 1; margin: 5px 0; }
        .right-slider-min-box { display: flex; flex-direction: column; align-items: center; flex: 1; width: 100%; }
        
        .bottom-controls { margin-top: 10px; padding: 0 5px; }
        .option-group { display: none; gap: 5px; }
        .overlay-box, .ma-box { display: flex; align-items: center; gap: 5px; background: #fff4e6; padding: 4px 8px; border-radius: 6px; border: 1px solid #ffe8cc; font-size: 12px; }
        .ma-box { background: #e8f6f3; border-color: #d1f2eb; }
        .ma-checks { display: flex; gap: 5px; margin-left: 5px; }
        .compare-input { width: 100px; display: none; } .compare-input.active { display: inline-block; }
        
        #loadingOverlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 100; text-align: center; padding-top: 200px; font-weight: bold; color: var(--point); backdrop-filter: blur(2px); border-radius: 12px; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loadingOverlay">Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        <div class="maker-sign">Made by KMW | v6.4 Fixes</div>
        <div class="header">
            <div><h2>üìà Í∏∞ÏóÖ Î∂ÑÏÑù <span id="industryBadge" class="badge gen">ÏùºÎ∞ò</span></h2></div>
            <div class="view-switch">
                <button class="view-btn active" onclick="setViewMode('graph')" id="btnGraph">üìä Í∑∏ÎûòÌîÑ</button>
                <button class="view-btn" onclick="setViewMode('table')" id="btnTable">‚ñ¶ ÌÖåÏù¥Î∏î</button>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="companyInput" list="compList" placeholder="Í∏∞ÏóÖÎ™Ö Í≤ÄÏÉâ..." style="flex:1; min-width:120px;">
            <datalist id="compList"></datalist>
            
            <div class="compare-box" style="display:flex; align-items:center; gap:5px; background:#eef2f5; padding:5px 10px; border-radius:6px; border:1px solid #ddd;">
                <input type="checkbox" id="compareToggle" onchange="toggleCompareMode()"> <label for="compareToggle" style="font-size:13px;">ÎπÑÍµê</label>
                <input type="text" id="compareInput" list="compList" class="compare-input" placeholder="ÎπÑÍµê Í∏∞ÏóÖ" onchange="updateChart()">
            </div>

            <div id="stockOptions" class="option-group">
                <div class="overlay-box"><input type="checkbox" id="resultOverlay" onchange="updateChart(true)"><label for="resultOverlay">Ïã§Ï†Å Ïò§Î≤ÑÎ†àÏù¥</label></div>
                <div class="ma-box"><span>MA:</span><div class="ma-checks">
                    <label><input type="checkbox" class="ma-chk" value="5" checked onchange="updateChart(true)">5</label>
                    <label><input type="checkbox" class="ma-chk" value="20" checked onchange="updateChart(true)">20</label>
                    <label><input type="checkbox" class="ma-chk" value="60" checked onchange="updateChart(true)">60</label>
                </div></div>
            </div>

            <div style="display:flex; gap:5px; flex:1;">
                <select id="periodSelect" onchange="updateChart()" style="flex:1"></select>
                <select id="unitSelect" onchange="updateChart()" style="width:80px;">
                    <option value="100000000" selected>ÏñµÏõê</option>
                    <option value="1000000000000">Ï°∞Ïõê</option>
                    <option value="1000000">Î∞±Îßå</option>
                </select>
            </div>
            <div id="consolControl" style="display:flex; background:#eee; border-radius:4px; padding:2px;">
                <input type="radio" name="consol" value="Î≥ÑÎèÑ" id="sep" checked onchange="updateChart()"><label for="sep" style="font-size:11px; padding:4px 8px; cursor:pointer;">Î≥ÑÎèÑ</label>
                <input type="radio" name="consol" value="Ïó∞Í≤∞" id="con" onchange="updateChart()"><label for="con" style="font-size:11px; padding:4px 8px; cursor:pointer;">Ïó∞Í≤∞</label>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('PL_MIX', this)">ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú</button>
            <button class="tab-btn" onclick="setTab('BS_MIX', this)">Ïû¨Î¨¥ÏÉÅÌÉúÌëú</button>
            <button class="tab-btn" onclick="setTab('CF', this)">ÌòÑÍ∏àÌùêÎ¶ÑÌëú</button>
            <button class="tab-btn" onclick="setTab('STOCK', this)">Ï£ºÍ∞Ä/ÏãúÏ¥ù</button>
        </div>

        <div class="main-container">
            <div class="chart-layout-row" id="graphView">
                <div class="y-slider-container" id="leftSliderBox">
                    <input type="range" id="leftMaxSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateLeftMax(this.value)">
                    <div style="width:100%; height:1px; background:#ccc;"></div>
                    <input type="range" id="leftMinSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateLeftMin(this.value)">
                </div>
                <div class="chart-scroll-box" id="chartScrollBox">
                    <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="y-slider-container right-side" id="rightSliderBox" style="display:none; background:#f3f0ff; border-color:#e5dbff;">
                    <input type="range" id="rightMaxSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateRightMax(this.value)">
                    <div style="width:100%; height:1px; background:#ccc;"></div>
                    <div class="right-slider-min-box" id="rightMinSliderContainer">
                        <input type="range" id="rightMinSlider" class="zoom-slider-vertical" min="50" max="300" value="110" oninput="updateRightMin(this.value)">
                    </div>
                </div>
            </div>

            <div class="table-container" id="tableView">
                <table id="dataTable">
                    <thead><tr><th>Ìï≠Î™©</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="bottom-controls">
            <div id="simpleZoomContainer" style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:12px;">‚Üî Í∞ÑÍ≤©</span>
                <input type="range" id="xZoomSlider" style="flex:1;" min="30" max="200" value="60" oninput="updateXScale(this.value)">
            </div>
            <div id="rangeSliderContainer" style="display:none; margin-top:10px;">
                <div id="rangeSlider"></div>
                <div id="rangeInfo" style="text-align:center; font-size:12px; margin-top:5px;"></div>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        let metadata={}, currentCompData=null, currentCompName='', currentTab='PL_MIX', myChart=null, currentViewMode='graph';
        let originalMaxY=0, originalMinY=0, originalMaxY1=0, originalMinY1=0, currentDataLength=0;

        const CONFIG_MAP = {
            'ÏùºÎ∞ò': {
                'PL_MIX': { type: 'financial', sources: ['PL', 'Profitability'], left_items: [{key: 'Îß§Ï∂úÏï°', color: '#36A2EB', type: 'bar'}, {key: 'ÏòÅÏóÖÏù¥Ïùµ', color: '#FF6384', type: 'bar'}], right_items: [{key: 'Îß§Ï∂úÏ¥ùÏù¥ÏùµÎ•†', color: '#FFCE56', type: 'line'}, {key: 'ÏòÅÏóÖÏù¥ÏùµÎ•†', color: '#4BC0C0', 'type': 'line'}] },
                'BS_MIX': { type: 'financial', sources: ['BS', 'Stability'], left_items: [{key: 'ÏûêÏÇ∞Ï¥ùÍ≥Ñ', color: '#36A2EB', type: 'bar'}, {key: 'Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ', color: '#FF6384', type: 'bar'}, {key: 'ÏûêÎ≥∏Ï¥ùÍ≥Ñ', color: '#9966FF', type: 'bar'}], right_items: [{key: 'Î∂ÄÏ±ÑÎπÑÏú®', color: '#FF9F40', type: 'line'}] }
            },
            'Í∏àÏúµ': {
                'PL_MIX': { type: 'financial', sources: ['PL', 'Profitability'], left_items: [{key: 'ÏòÅÏóÖÏàòÏùµ', color: '#36A2EB', type: 'bar'}, {key: 'ÏòÅÏóÖÏù¥Ïùµ', color: '#FF6384', type: 'bar'}], right_items: [{key: 'ÏàúÏù¥ÏùµÎ•†', color: '#FFCE56', type: 'line'}, {key: 'ÏòÅÏóÖÏù¥ÏùµÎ•†', color: '#4BC0C0', 'type': 'line'}] },
                'BS_MIX': { type: 'financial', sources: ['BS', 'Stability'], left_items: [{key: 'ÏûêÏÇ∞Ï¥ùÍ≥Ñ', color: '#36A2EB', type: 'bar'}, {key: 'Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ', color: '#FF6384', type: 'bar'}, {key: 'ÏûêÎ≥∏Ï¥ùÍ≥Ñ', color: '#9966FF', type: 'bar'}], right_items: [{key: 'Î∂ÄÏ±ÑÎπÑÏú®', color: '#FF9F40', type: 'line'}] }
            }
        };
        const COMMON_CONFIG = {
            'CF': { type: 'financial', sources: ['CF'], left_items: [{key: 'Ïû¨Î¨¥ÌôúÎèôCF', color: '#36A2EB', type: 'line'}, {key: 'Ìà¨ÏûêÌôúÎèôCF', color: '#FF6384', type: 'line'}, {key: 'ÏòÅÏóÖÌôúÎèôCF', color: '#4BC0C0', type: 'line'}], right_items: [] },
            'STOCK': { type: 'stock', left_items: [{key: 'marcap', label: 'ÏãúÍ∞ÄÏ¥ùÏï°', color: 'transparent', type: 'line', fill: false}], right_items: [] }
        };
        Object.keys(CONFIG_MAP).forEach(k => Object.assign(CONFIG_MAP[k], COMMON_CONFIG));

        const TABLE_ROWS = {
            'PL_MIX': [
                {k:'Îß§Ï∂úÏï°', l:'Îß§Ï∂úÏï°(ÏàòÏùµ)'}, {k:'Îß§Ï∂úÏ¥ùÏù¥Ïùµ', l:'Îß§Ï∂úÏ¥ùÏù¥Ïùµ'}, {k:'Îß§Ï∂úÏ¥ùÏù¥ÏùµÎ•†', l:'GP%', p:true},
                {k:'ÌåêÎß§ÎπÑÏôÄÍ¥ÄÎ¶¨ÎπÑ', l:'ÌåêÎß§ÎπÑÏôÄÍ¥ÄÎ¶¨ÎπÑ'}, {k:'ÏòÅÏóÖÏù¥Ïùµ', l:'ÏòÅÏóÖÏù¥Ïùµ'}, {k:'ÏòÅÏóÖÏù¥ÏùµÎ•†', l:'OP%', p:true},
                {k:'ÏòÅÏóÖÏô∏ÏÜêÏùµ', l:'ÏòÅÏóÖÏô∏ÏÜêÏùµ'}, {k:'ÎãπÍ∏∞ÏàúÏù¥Ïùµ', l:'ÎãπÍ∏∞ÏàúÏù¥Ïùµ'}, {k:'ÏàúÏù¥ÏùµÎ•†', l:'NI%', p:true}
            ],
            'BS_MIX': [
                {k:'ÏûêÏÇ∞Ï¥ùÍ≥Ñ', l:'ÏûêÏÇ∞Ï¥ùÍ≥Ñ'}, {k:'Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ', l:'Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ'}, {k:'ÏûêÎ≥∏Ï¥ùÍ≥Ñ', l:'ÏûêÎ≥∏Ï¥ùÍ≥Ñ'}, {k:'Î∂ÄÏ±ÑÎπÑÏú®', l:'Î∂ÄÏ±ÑÎπÑÏú®', p:true}
            ],
            'CF': [
                {k:'ÏòÅÏóÖÌôúÎèôCF', l:'ÏòÅÏóÖÌôúÎèôCF'}, {k:'Ìà¨ÏûêÌôúÎèôCF', l:'Ìà¨ÏûêÌôúÎèôCF'}, {k:'Ïû¨Î¨¥ÌôúÎèôCF', l:'Ïû¨Î¨¥ÌôúÎèôCF'}, {k:'Í∏∞Ï¥àÌòÑÍ∏à', l:'Í∏∞Ï¥àÌòÑÍ∏à'}, {k:'Í∏∞ÎßêÌòÑÍ∏à', l:'Í∏∞ÎßêÌòÑÍ∏à'}
            ]
        };

        const ORDER_PRIORITY = ['ÏòÅÏóÖÏàòÏùµ', 'Îß§Ï∂úÏï°', 'ÏòÅÏóÖÏù¥Ïùµ', 'ÏàúÏù¥ÏùµÎ•†', 'Îß§Ï∂úÏ¥ùÏù¥ÏùµÎ•†', 'ÏòÅÏóÖÏù¥ÏùµÎ•†', 'ÏûêÏÇ∞Ï¥ùÍ≥Ñ', 'Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ', 'ÏûêÎ≥∏Ï¥ùÍ≥Ñ', 'Î∂ÄÏ±ÑÎπÑÏú®', 'ÏòÅÏóÖÌôúÎèôCF', 'Ìà¨ÏûêÌôúÎèôCF', 'Ïû¨Î¨¥ÌôúÎèôCF', 'ÏãúÍ∞ÄÏ¥ùÏï°', 'Ï£ºÍ∞Ä'];

        window.onload = async () => {
            try {
                metadata = await (await fetch('metadata.json')).json();
                const list = document.getElementById('compList');
                Object.keys(metadata).sort().forEach(n => { let o=document.createElement('option'); o.value=n; list.appendChild(o); });
                const first = Object.keys(metadata).sort()[0];
                if(first) { document.getElementById('companyInput').value=first; loadCompanyData(first); }
            } catch(e) { alert("Loading Fail"); }
        };

        async function loadCompanyData(name) {
            if(!metadata[name]) return;
            document.getElementById('loadingOverlay').style.display='block';
            currentCompName = name;
            try {
                const res = await fetch(`data/${metadata[name].code}.json`);
                if(!res.ok) throw new Error("File missing");
                currentCompData = await res.json();
                updateMetaInfo(); initPeriodSelect(); updateChart();
            } catch(e) { alert("Data Error: "+e.message); }
            finally { document.getElementById('loadingOverlay').style.display='none'; }
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            document.getElementById('btnGraph').className = mode==='graph' ? 'view-btn active' : 'view-btn';
            document.getElementById('btnTable').className = mode==='table' ? 'view-btn active' : 'view-btn';
            document.getElementById('graphView').style.display = mode==='graph' ? 'flex' : 'none';
            document.getElementById('tableView').className = mode==='table' ? 'table-container active' : 'table-container';
            document.querySelector('.bottom-controls').style.display = mode==='graph' ? 'block' : 'none';
            if(mode==='table') updateChart();
        }

        function setTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            const conf = getCurrConfig();
            const isStock = conf.type === 'stock';
            
            document.getElementById('consolControl').style.display = isStock ? 'none' : 'flex';
            document.getElementById('periodSelect').style.visibility = isStock ? 'hidden' : 'visible';
            document.getElementById('stockOptions').style.display = isStock ? 'flex' : 'none';
            document.getElementById('rightSliderBox').style.display = isStock ? 'flex' : 'none';
            document.getElementById('simpleZoomContainer').style.display = isStock ? 'none' : 'flex';
            document.getElementById('rangeSliderContainer').style.display = isStock ? 'block' : 'none';
            
            // [ÏàòÏ†ï] Ï£ºÍ∞Ä ÌÉ≠ÏóêÏÑú ÌÖåÏù¥Î∏î Î≤ÑÌäº Ïà®Í∏∞Í∏∞
            const btnTable = document.getElementById('btnTable');
            if(isStock) {
                btnTable.style.display = 'none';
                if(currentViewMode==='table') setViewMode('graph'); 
            } else {
                btnTable.style.display = 'inline-block';
            }

            const box = document.getElementById('chartScrollBox');
            if(isStock) box.classList.add('no-scroll'); else box.classList.remove('no-scroll');

            updateChart();
        }

        function getCurrConfig() {
            const type = (currentCompData && currentCompData.type) || 'ÏùºÎ∞ò';
            return (CONFIG_MAP[type] || CONFIG_MAP['ÏùºÎ∞ò'])[currentTab];
        }

        function initPeriodSelect() { 
            const sel = document.getElementById('periodSelect'); sel.innerHTML = ''; 
            const opts = [{'v': 'ALL_Q', 't': 'Ï†ÑÏ≤¥ Î∂ÑÍ∏∞ Ï∂îÏù¥'}, {'v': 'ALL_Y', 't': 'Ïó∞ÎèÑÎ≥Ñ Ìï©Í≥Ñ'}, {'v': 'divider', 't': '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'd': true}, {'v': 'CUM_1Q', 't': '1Î∂ÑÍ∏∞ ÎàÑÏ†Å'}, {'v': 'CUM_2Q', 't': 'ÏÉÅÎ∞òÍ∏∞ ÎàÑÏ†Å'}, {'v': 'CUM_3Q', 't': '3Î∂ÑÍ∏∞ ÎàÑÏ†Å'}, {'v': 'CUM_4Q', 't': 'Ïó∞Í∞Ñ ÎàÑÏ†Å'}, {'v': 'divider', 't': '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'd': true}, {'v': 'COMP_1Q', 't': '1Q ÎπÑÍµê'}, {'v': 'COMP_2Q', 't': '2Q ÎπÑÍµê'}, {'v': 'COMP_3Q', 't': '3Q ÎπÑÍµê'}, {'v': 'COMP_4Q', 't': '4Q ÎπÑÍµê'}]; 
            opts.forEach(o => { let e = document.createElement('option'); e.value = o.v; e.text = o.t; if(o.d) e.disabled = true; sel.appendChild(e); }); 
            const type = document.querySelector('input[name="consol"]:checked').value; 
            let years = new Set(); 
            const compType = (currentCompData && currentCompData.type) || 'ÏùºÎ∞ò';
            const currentConfig = CONFIG_MAP[compType] || CONFIG_MAP['ÏùºÎ∞ò'];
            currentConfig['PL_MIX'].sources.forEach(src => { 
                if(currentCompData.data[type] && currentCompData.data[type][src]) 
                    currentCompData.data[type][src].forEach(r => years.add(r.year)); 
            }); 
            let d2 = document.createElement('option'); d2.disabled = true; d2.text = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"; sel.appendChild(d2); 
            Array.from(years).sort().forEach(y => { let e = document.createElement('option'); e.value = y; e.text = y + "ÎÖÑ ÏÉÅÏÑ∏"; sel.appendChild(e); }); 
        }

        async function updateChart(keepZoom = false) {
            if(!currentCompData) return;
            const ctx = document.getElementById('mainChart').getContext('2d');
            const consol = document.querySelector('input[name="consol"]:checked').value;
            const tabCfg = getCurrConfig();
            const isStock = tabCfg.type === 'stock';
            const period = document.getElementById('periodSelect').value;
            const unit = parseFloat(document.getElementById('unitSelect').value);
            const showOverlay = document.getElementById('resultOverlay').checked && isStock;

            const isComp = document.getElementById('compareToggle').checked;
            const compBName = document.getElementById('compareInput').value;
            let compBData = null;
            if (isComp && compBName && metadata[compBName]) {
                try {
                    const res = await fetch(`data/${metadata[compBName].code}.json`);
                    if(res.ok) compBData = await res.json();
                } catch(e) {}
            }
            const hasComp = !!compBData;

            let finalLabels=[], finalDataA=[], finalDataB=[];

            if(isStock) {
                const getS = (d) => d && d.stock_data ? d.stock_data : [];
                let sA = getS(currentCompData), sB = hasComp ? getS(compBData) : [];
                let allD = new Set(sA.map(d=>d.date)); if(hasComp) sB.forEach(d=>allD.add(d.date));
                finalLabels = Array.from(allD).sort();
                const mapS = (src) => finalLabels.map(date => src.find(k=>k.date===date) || {});
                finalDataA = mapS(sA); finalDataB = hasComp ? mapS(sB) : [];
            } else {
                const proc = (dObj) => {
                    let m={}; if(!dObj || !dObj.data[consol]) return [];
                    (tabCfg.sources||['PL']).forEach(s => {
                        if(dObj.data[consol][s]) dObj.data[consol][s].forEach(r => m[r.label] = {...(m[r.label]||{}), ...r});
                    });
                    let f = Object.values(m).sort((a,b) => (a.year-b.year)||(a.quarter-b.quarter));
                    
                    if(period==='ALL_Y' || period.startsWith('CUM_')) {
                        const ys = [...new Set(f.map(d=>d.year))];
                        const tQ = period.startsWith('CUM_') ? parseInt(period.split('_')[1].replace('Q','')) : 4;
                        return ys.map(y => {
                            const its = f.filter(d => d.year===y && d.quarter<=tQ);
                            if(!its.length) return null;
                            let r = {label: `${y}ÎÖÑ ${typeLabel(tQ)}`, year:y};
                            const sum = (k) => its.reduce((a,c) => a+(c[k]||0), 0);
                            
                            const sales = sum('Îß§Ï∂úÏï°') || sum('ÏòÅÏóÖÏàòÏùµ');
                            const gp = sum('Îß§Ï∂úÏ¥ùÏù¥Ïùµ');
                            const op = sum('ÏòÅÏóÖÏù¥Ïùµ');
                            const ni = sum('ÎãπÍ∏∞ÏàúÏù¥Ïùµ') || sum('ÏàúÏù¥Ïùµ');
                            
                            [...tabCfg.left_items, ...tabCfg.right_items, ...TABLE_ROWS['PL_MIX'], ...TABLE_ROWS['BS_MIX'], ...TABLE_ROWS['CF']].forEach(item => {
                                let k = item.key || item.k;
                                if(!k) return;
                                if(['ÏûêÏÇ∞Ï¥ùÍ≥Ñ','Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ','ÏûêÎ≥∏Ï¥ùÍ≥Ñ','Í∏∞ÎßêÌòÑÍ∏à','Î∂ÄÏ±ÑÎπÑÏú®'].includes(k)) {
                                    r[k] = its[its.length-1][k];
                                } else {
                                    r[k] = sum(k);
                                }
                            });

                            if(sales) {
                                r['Îß§Ï∂úÏ¥ùÏù¥ÏùµÎ•†'] = (gp/sales)*100;
                                r['ÏòÅÏóÖÏù¥ÏùµÎ•†'] = (op/sales)*100;
                                r['ÏàúÏù¥ÏùµÎ•†'] = (ni/sales)*100;
                            }
                            if(r['ÏûêÎ≥∏Ï¥ùÍ≥Ñ']) r['Î∂ÄÏ±ÑÎπÑÏú®'] = (r['Î∂ÄÏ±ÑÏ¥ùÍ≥Ñ']/r['ÏûêÎ≥∏Ï¥ùÍ≥Ñ'])*100;
                            return r;
                        }).filter(d=>d);
                    } else if(period.startsWith('COMP_')) {
                        return f.filter(d => d.quarter === parseInt(period.split('_')[1].replace('Q','')));
                    } else if(period !== 'ALL_Q') {
                        return f.filter(d => d.year == period);
                    }
                    return f;
                };
                finalDataA = proc(currentCompData);
                finalDataB = hasComp ? proc(compBData) : [];
                let allL = new Set(finalDataA.map(d=>d.label)); if(hasComp) finalDataB.forEach(d=>allL.add(d.label));
                finalLabels = Array.from(allL).sort();
                const mapD = (s,l) => l.map(lb=>s.find(d=>d.label===lb)||{});
                finalDataA = mapD(finalDataA, finalLabels); finalDataB = hasComp ? mapD(finalDataB, finalLabels) : [];
            }

            if (currentViewMode === 'table' && !isStock) {
                renderTable(finalDataA, unit);
            } else {
                currentDataLength = finalLabels.length;
                const fs = window.innerWidth<=768?10:12;
                
                let savedStartIdx=0, savedEndIdx=0;
                if(keepZoom && isStock) {
                    const sliderEl = document.getElementById('rangeSlider');
                    if(sliderEl && sliderEl.noUiSlider) {
                        const vals = sliderEl.noUiSlider.get();
                        savedStartIdx = parseInt(vals[0]); savedEndIdx = parseInt(vals[1]);
                    }
                }

                let maxY=0, minY=0, maxY1=-Infinity, minY1=Infinity;
                if(!isStock) {
                    maxY1=0; minY1=0;
                    const check = (d) => {
                        if(!d) return;
                        tabCfg.left_items.forEach(i=>{ let v=(d[i.key]||0)/unit; if(v>maxY)maxY=v; if(v<minY)minY=v; });
                        tabCfg.right_items.forEach(i=>{ let v=(d[i.key]||0); if(v>maxY1)maxY1=v; if(v<minY1)minY1=v; });
                    };
                    finalDataA.forEach(check); if(hasComp) finalDataB.forEach(check);
                } else {
                    finalDataA.forEach(d => { if(d.high>0) { maxY1=Math.max(maxY1,d.high); minY1=Math.min(minY1,d.low); } });
                    if(hasComp) finalDataB.forEach(d => { if(d.high>0) { maxY1=Math.max(maxY1,d.high); minY1=Math.min(minY1,d.low); } });
                    if(maxY1===-Infinity) maxY1=100; if(minY1===Infinity) minY1=0;
                    if(showOverlay) {
                        const pData = getPerformanceData(currentCompData, consol, finalLabels);
                        [...pData.rev, ...pData.prof].forEach(v => { if(v!==null){ let val=v/unit; if(val>maxY)maxY=val; if(val<minY)minY=val; } });
                    }
                }
                originalMaxY=maxY*1.1; originalMinY=minY*1.1; originalMaxY1=maxY1*1.1; originalMinY1=minY1*0.9;
                
                if(!keepZoom) { ['leftMaxSlider','leftMinSlider','rightMaxSlider','rightMinSlider'].forEach(id=>document.getElementById(id).value=110); }

                let datasets = [];
                const createDs = (isB, item, isLine, orderBase, customData=null) => {
                    const target = customData ? customData : (isB ? finalDataB : finalDataA);
                    const name = isB ? compBName : currentCompName;
                    const label = hasComp ? `${name}-${item.label||item.key}` : (item.label||item.key);
                    let color = item.color, dash = item.borderDash||[], pStyle = item.type==='bar'?'rect':'circle';
                    
                    if(item.key==='marcap' && !isB) { color='transparent'; pStyle='circle'; }
                    else if(isB) { color='#95a5a6'; if(item.type==='line') dash=[5,5]; pStyle='triangle'; }
                    
                    // [ÏàòÏ†ï] Í∫æÏùÄÏÑ† Í∑∏ÎûòÌîÑ(Ïù¥ÏùµÎ•† Îì±)Ïùò Î≤îÎ°ÄÎ•º 'ÏÑ†(line)' Î™®ÏñëÏúºÎ°ú Î≥ÄÍ≤Ω
                    if (item.type === 'line') pStyle = 'line'; 

                    let yID = (isLine && !customData && item.key!=='marcap') ? 'y1' : 'y';
                    if(item.key==='marcap') yID='y_marcap';

                    return {
                        label: label,
                        data: target.map(d => {
                            let val = customData ? d : (d[item.key]||0);
                            if(customData && val===null) return null;
                            return (isLine && !customData && item.key!=='marcap') ? val : Math.round(val/unit);
                        }),
                        backgroundColor: isB?'transparent':(item.fill?color+'33':color),
                        borderColor: color, type: item.type, yAxisID: yID,
                        fill: item.fill&&!isB, order: orderBase+(isB?1:0),
                        pointStyle: pStyle, borderDash: dash, tension: 0.4, borderWidth: 2,
                        pointRadius: isStock? (customData?4:0) : 3, spanGaps: true,
                        datalabels: { display: (c)=>!isStock&&!isB&&c.dataset.data.length<50, anchor:'end', align:'top', font:{size:fs}, formatter:(v)=>(isLine&&!isStock)?v.toFixed(1)+'%':v.toLocaleString() }
                    };
                };

                if(isStock) {
                    const candles = finalDataA.map(d => ({ x: d.date, o: d.open, h: d.high, l: d.low, c: d.close }));
                    datasets.push({ label: currentCompName, data: candles, type: 'candlestick', yAxisID: 'y1', order: 1, color: { up: '#e74c3c', down: '#3498db', unchanged: '#999' }, datalabels:{display:false} });
                    const maColors = {5:'#2ecc71', 10:'#9b59b6', 20:'#f1c40f', 60:'#e67e22', 120:'#95a5a6'};
                    document.querySelectorAll('.ma-chk:checked').forEach(chk => {
                        const p = parseInt(chk.value);
                        datasets.push({ label: `MA${p}`, data: calculateMA(finalDataA, p), type: 'line', yAxisID: 'y1', borderColor: maColors[p]||'#333', borderWidth: 1, pointRadius: 0, order: 0, datalabels:{display:false} });
                    });
                    tabCfg.left_items.forEach(i=>datasets.push(createDs(false, i, false, 10)));
                    if(hasComp) datasets.push({ label: compBName+' (Ï¢ÖÍ∞Ä)', data: finalDataB.map(d=>d.close), type: 'line', yAxisID: 'y1', borderColor: '#7f8c8d', borderWidth: 2, pointRadius: 0, borderDash: [5,5], order: 2, datalabels: { display: false } });
                    if(showOverlay) {
                        const pData = getPerformanceData(currentCompData, consol, finalLabels);
                        datasets.push(createDs(false, {key:'overlay_rev', label:'Îß§Ï∂ú(Ïã§Ï†Å)', color:'#36A2EB', type:'line', borderDash:[2,2]}, false, 5, pData.rev));
                        datasets.push(createDs(false, {key:'overlay_prof', label:'Ïù¥Ïùµ(Ïã§Ï†Å)', color:'#FF6384', type:'line', borderDash:[2,2]}, false, 5, pData.prof));
                    }
                } else {
                    tabCfg.left_items.forEach(i=>{ datasets.push(createDs(false, i, false, 10)); if(hasComp) datasets.push(createDs(true, i, false, 11)); });
                    tabCfg.right_items.forEach(i=>{ datasets.push(createDs(false, i, true, 0)); if(hasComp) datasets.push(createDs(true, i, true, 1)); });
                }

                if(myChart) myChart.destroy();
                const hasRight = tabCfg.right_items.length > 0 || isStock;
                document.getElementById('rightSliderBox').style.display = hasRight ? 'flex' : 'none';
                
                let y1Opt = isStock 
                    ? { type: 'linear', display: hasRight, position: 'right', min: originalMinY1*0.9, max: originalMaxY1*(keepZoom?document.getElementById('rightMaxSlider').value/100:1.1), grid:{drawOnChartArea:false} }
                    : { type: 'linear', display: hasRight, position: 'right', suggestedMin: originalMinY1, suggestedMax: originalMaxY1, grid:{drawOnChartArea:false} };

                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: finalLabels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'top', labels:{ boxWidth:12, font:{size:fs+1}, usePointStyle: true, sort: (a,b) => { const gk=(s)=>s.includes(' - ')?s.split(' - ')[1]:s; const ai=ORDER_PRIORITY.indexOf(gk(a.text)), bi=ORDER_PRIORITY.indexOf(gk(b.text)); if(ai===-1)return 1; if(bi===-1)return -1; return ai-bi; } } } },
                        scales: {
                            x: { type: isStock?'time':'category', time:{unit:'month', displayFormats:{month:'yy.MM'}}, offset:!isStock, min: (keepZoom&&isStock)?finalLabels[savedStartIdx]:undefined, max: (keepZoom&&isStock)?finalLabels[savedEndIdx]:undefined },
                            y: { display: !isStock||showOverlay, position:'left', suggestedMax: originalMaxY, suggestedMin: originalMinY },
                            y1: y1Opt,
                            y_marcap: { type: 'linear', display: false }
                        }
                    }
                });

                if(isStock && !keepZoom) initRangeSlider(finalLabels);
                else if(!isStock) updateXScale(document.getElementById('xZoomSlider').value);
            }
        }

        function renderTable(data, unit) {
            const tableHead = document.querySelector('#dataTable thead tr');
            const tableBody = document.querySelector('#dataTable tbody');
            tableHead.innerHTML = '<th>Ìï≠Î™©</th>';
            tableBody.innerHTML = '';

            if(!data || data.length === 0) { tableBody.innerHTML = '<tr><td colspan="5">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>'; return; }

            data.forEach(d => {
                let th = document.createElement('th');
                th.innerText = d.label;
                tableHead.appendChild(th);
            });

            const rows = TABLE_ROWS[currentTab] || [];
            rows.forEach(rowDef => {
                let tr = document.createElement('tr');
                if(rowDef.p) tr.className = 'row-pct';
                
                let tdName = document.createElement('td');
                tdName.innerText = rowDef.l;
                tr.appendChild(tdName);

                data.forEach(d => {
                    let td = document.createElement('td');
                    let val = d[rowDef.k] || d[rowDef.k.replace('Î•†','Ïú®')];
                    
                    if (val === undefined || val === null) {
                        td.innerText = '-';
                    } else {
                        if (rowDef.p) { 
                            td.innerText = val.toFixed(1) + '%';
                            if(val < 0) td.style.color = 'red';
                        } else { 
                            td.innerText = Math.round(val / unit).toLocaleString();
                        }
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        function typeLabel(q) { if(q===1) return '1QÎàÑÏ†Å'; if(q===2) return 'ÏÉÅÎ∞òÍ∏∞'; if(q===3) return '3QÎàÑÏ†Å'; return 'Ïó∞Í∞Ñ'; }
        function updateMetaInfo() {
            const d = currentCompData;
            document.getElementById('industryBadge').innerText = d.type;
            document.getElementById('industryBadge').className = 'badge ' + (d.type==='Í∏àÏúµ'?'fin':'gen');
            const sep = document.getElementById('sep'), con = document.getElementById('con');
            if(!d.data['Ïó∞Í≤∞']) { con.disabled=true; sep.checked=true; } else con.disabled=false;
            if(!d.data['Î≥ÑÎèÑ']) { sep.disabled=true; con.checked=true; } else sep.disabled=false;
        }
        function calculateMA(data, period) { 
            let ma = []; for(let i=0; i<data.length; i++) { if(i<period-1){ma.push(null); continue;} let sum=0; for(let j=0; j<period; j++) sum+=data[i-j].close; ma.push(sum/period); } return ma; 
        }
        function getPerformanceData(compData, consolType, stockDates) {
            if (!compData || !compData.data[consolType]) return { rev: [], prof: [] };
            let plData = compData.data[consolType]['PL'] || [];
            const qEndMap = {1: '03-31', 2: '06-30', 3: '09-30', 4: '12-31'};
            let rMap = {}, pMap = {};
            plData.forEach(item => { if(item.year && item.quarter) { const dStr = `${item.year}-${qEndMap[item.quarter]}`; rMap[dStr] = item['Îß§Ï∂úÏï°']||item['ÏòÅÏóÖÏàòÏùµ']||0; pMap[dStr] = item['ÏòÅÏóÖÏù¥Ïùµ']||0; } });
            let rev = Array(stockDates.length).fill(null), prof = Array(stockDates.length).fill(null);
            Object.keys(rMap).forEach(td => { let idx = stockDates.indexOf(td); if (idx === -1) for (let i = stockDates.length - 1; i >= 0; i--) if (stockDates[i] < td) { idx = i; break; } if (idx !== -1) { rev[idx] = rMap[td]===0?null:rMap[td]; prof[idx] = pMap[td]===0?null:pMap[td]; } });
            return { rev, prof };
        }
        function updateLeftMax(v) { if(myChart) { myChart.options.scales.y.max = (originalMaxY||100)*(v/100); myChart.update(); }}
        function updateLeftMin(v) { if(myChart) { myChart.options.scales.y.min = (originalMinY||0)*(v/100); myChart.update(); }}
        function updateRightMax(v) { if(myChart) { myChart.options.scales.y1.max = (originalMaxY1||10)*(v/100); myChart.update(); }}
        function updateRightMin(v) { if(myChart) { myChart.options.scales.y1.min = (originalMinY1||0)*(v/100); myChart.update(); }}
        function updateXScale(v) { document.querySelector('.chart-wrapper').style.width = Math.max(document.querySelector('.chart-scroll-box').clientWidth, currentDataLength*v)+'px'; }
        
        function initRangeSlider(labels) {
            const sliderEl = document.getElementById('rangeSlider'); if (!sliderEl) return;
            if (sliderEl.noUiSlider) sliderEl.noUiSlider.destroy();
            if (!labels || labels.length === 0) return;
            noUiSlider.create(sliderEl, { start: [0, labels.length-1], connect: true, range: {'min': 0, 'max': labels.length-1}, step: 1, behaviour: 'drag-tap' });
            sliderEl.noUiSlider.on('update', function (values) {
                const sVal = parseInt(values[0]), eVal = parseInt(values[1]);
                document.getElementById('rangeInfo').innerText = `${labels[sVal]} ~ ${labels[eVal]}`;
                if (myChart && getCurrConfig().type === 'stock') { 
                    myChart.options.scales.x.min = labels[sVal]; myChart.options.scales.x.max = labels[eVal]; myChart.update('none'); 
                }
            });
        }
        function downloadExcel() { if (!currentCompData) return; const type = document.querySelector('input[name="consol"]:checked').value; const wb = XLSX.utils.book_new(); ['PL', 'BS', 'CF', 'Profitability', 'Stability'].forEach(s => { if (currentCompData.data[type][s]) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(currentCompData.data[type][s]), s); }); if (currentCompData.stock_data) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(currentCompData.stock_data), 'Stock_Price'); XLSX.writeFile(wb, `${currentCompName}_ÌÜµÌï©Îç∞Ïù¥ÌÑ∞.xlsx`); }

        document.getElementById('companyInput').addEventListener('change', (e)=>loadCompanyData(e.target.value));
        window.addEventListener('resize', ()=>updateChart());
    </script>
</body>
</html>
